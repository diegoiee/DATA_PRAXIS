EXEC('CREATE SCHEMA [DATA_PRAXIS] AUTHORIZATION [dbo]')


--EXEC('DROP SCHEMA [DATA_PRAXIS]')


CREATE TABLE DATA_PRAXIS.PLAN_MEDICO ( --OK
	id_plan_medico numeric(18,0) PRIMARY KEY,      --plan_med_codigo
	desc_plan_medico VARCHAR(255) NULL,            --plan_med_descripcion
	precio_bono_consulta numeric(18,0),            --plan_med_precio_bono_consulta
	fecha_asiento_precio_bono_consulta DATETIME,   
	precio_bono_farmacia numeric(18,0),            --plan_med_precio_bono_farmacia
	fecha_asiento_precio_bono_farmacia DATETIME
)


CREATE TABLE [DATAP_PRAXIS.HORARIO_TURNO]( --OK
[id_horario_turno] [TINYINT] PRIMARY KEY,
[horario_turno] VARCHAR(255) NOT NULL
)

CREATE TABLE DATA_PRAXIS.TIPO_DOCUMENTO ( --OK
	id_tipo_documento TINYINT PRIMARY KEY,
	descripcion_tipo_documento VARCHAR(20) NOT NULL
)

CREATE TABLE  DATA_PRAXIS.SEXO ( --OK
	id_sexo TINYINT PRIMARY KEY,
	descripcion_sexo VARCHAR(20) NOT NULL
)

CREATE TABLE  DATA_PRAXIS.ESTADO_CIVIL ( --OK
[id_estado_civil] [TINYINT] PRIMARY KEY,
[descripcion_estado_civil] VARCHAR(255) NOT NULL
)

CREATE TABLE DATA_PRAXIS.ESTADO_TURNO ( -- OK
[id_estado_turno] [TINYINT] PRIMARY KEY,
[descripcion_estado_turno] VARCHAR(255) NOT NULL
)



CREATE TABLE [DATA_PRAXIS].[PERSONA]( --OK
	[id_persona] [BIGINT] PRIMARY KEY IDENTITY(1,1),
	[id_tipo_documento] [TINYINT] NOT NULL FOREIGN KEY REFERENCES [DATA_PRAXIS].[TIPO_DOCUMENTO](id_tipo_documento),
	[numero_documento] [NUMERIC](18,0) NOT NULL, --paciente_dni o medico_dni
	[nombre] [varchar](255)  not null,	     --paciente_nombre o medico_nombre
	[apellido] [varchar](255) not null,          --paciente_apellido o medico_apellido
	[telefono] [numeric](18,0) not null,         --paciente_telefono o medico_telefono
	[direccion] [varchar](255) not null,          --paciente_direccion o medico_direccion
	[mail] [varchar](255) not null,              --paciente_mail o medico_mail
	[fecha_nacimiento] [DATETIME] not null,      --paciente_fecha_nac o medico_fecha_nac
	[id_sexo][TINYINT] FOREIGN KEY REFERENCES [DATA_PRAXIS].[SEXO] (id_sexo),
	[cantidad_familiares_a_cargo][int] not null DEFAULT 0,
	[id_estado_civil] [TINYINT] FOREIGN KEY REFERENCES [DATA_PRAXIS].[ESTADO_CIVIL](id_estado_civil)
)

CREATE TABLE [DATA_PRAXIS].[AFILIADO] ( --OK
        [id_afiliado] [BIGINT],
        [id_persona] [BIGINT] NOT NULL FOREIGN KEY REFERENCES [DATA_PRAXIS].[PERSONA] (id_persona),
        [id_plan_medico] [numeric](18,0) NOT NULL FOREIGN KEY REFERENCES [DATA_PRAXIS].[PLAN_MEDICO] (id_plan_medico), --plan_med_codigo
        [numero_consulta] [int]  DEFAULT 0,
        [fecha_baja] [datetime] DEFAULT NULL
)

CREATE TABLE DATA_PRAXIS.PROFESIONAL ( --OK
	id_profesional BIGINT IDENTITY (1,1) PRIMARY KEY,
	[id_persona] [BIGINT] NOT NULL FOREIGN KEY REFERENCES [DATA_PRAXIS].[PERSONA] (id_persona),
	matricula numeric(18,0) DEFAULT NULL,
	fecha_de_baja DATETIME DEFAULT NULL
)


CREATE TABLE [DATA_PRAXIS].[TIPO_ESPECIALIDAD]( --OK
	[id_tipo_especialidad] NUMERIC(18,0) PRIMARY KEY,
	[descripcion_tipo_especialidad] [varchar](255) NOT NULL
)


CREATE TABLE [DATA_PRAXIS].[ESPECIALIDAD]( --OK
	[id_especialidad] NUMERIC(18,0) PRIMARY KEY,
	[id_tipo_especialidad] NUMERIC (18,0) FOREIGN KEY REFERENCES DATA_PRAXIS.TIPO_ESPECIALIDAD (ID_TIPO_ESPECIALIDAD),
	[descripcion_especialidad] [varchar](255) NOT NULL
)

CREATE TABLE [DATA_PRAXIS].[PROFESIONAL_ESPECIALIDAD] (--OK
        [id_profesional] [BIGINT] not null FOREIGN KEY REFERENCES [DATA_PRAXIS].[PROFESIONAL] (id_profesional),
        [id_especialidad ][numeric](18,0) not null FOREIGN KEY REFERENCES [DATA_PRAXIS].[ESPECIALIDAD] (id_especialidad)
)

GO
CREATE FUNCTION DATA_PRAXIS.OBTENER_ID_PERSONA
(
	@dni numeric(18,0)
)
RETURNS BIGINT
AS
BEGIN
	DECLARE @id_persona_retorno numeric(18,0)

	set @id_persona_retorno = (	SELECT id_persona 
					from DATA_PRAXIS.PERSONA 
					WHERE numero_documento = @dni)
	RETURN @id_persona_retorno 
END
GO


--select dbo.Obtener_id_Persona(Paciente_dni) from gd_esquema.Maestra


--//////////////////////////////////////////////////////////////////////////////////////
--/////////////////////////////////////////////////////////////////////////////////////
--/////////////////////////////      MIGRACION     ///////////////////////////////////
--///////////////////////////////////////////////////////////////////////////////////
--//////////////////////////////////////////////////////////////////////////////////
/*
En general el problema es repetir varias veces la consulta de la tabla maestra.
Estaria bueno poder en una misma consulta migrar varias tablas, 
recorriendo una unica vez todas las filas y segun que condicion cumpla cada fila hacer un insert a una u otra tabla
*/

--TIPO_DNI --OK
------------- 
INSERT INTO DATA_PRAXIS.TIPO_DOCUMENTO VALUES(1,'DNI')

--PERSONA --OK
------------- 
INSERT INTO DATA_PRAXIS.PERSONA(
id_tipo_documento,
numero_documento,
nombre,
apellido,
telefono,
direccion,
mail,
fecha_nacimiento,
id_sexo,
cantidad_familiares_a_cargo,
id_estado_civil)

SELECT DISTINCT
1, --tipodoc 
ISNULL(medico_dni,paciente_dni),
ISNULL(medico_nombre,paciente_nombre),
ISNULL(medico_apellido,paciente_apellido),
ISNULL(medico_telefono,paciente_telefono),
ISNULL(medico_direccion,paciente_direccion),
ISNULL(medico_mail,paciente_mail),
ISNULL(medico_fecha_nac,paciente_fecha_nac),
NULL,--id_sexo
0,--cant familiares a cargo
NULL--id_estado_civil

FROM gd_esquema.Maestra

--PLAN_MEDICO--
-------------

INSERT INTO DATA_PRAXIS.PLAN_MEDICO
SELECT DISTINCT 
plan_med_codigo,
plan_med_descripcion,
plan_med_precio_bono_consulta,
NULL,
plan_med_precio_bono_farmacia,
NULL
FROM gd_esquema.Maestra


--AFILIADO --OK
-------------
INSERT INTO DATA_PRAXIS.AFILIADO
SELECT
(ROW_NUMBER()OVER(order by Paciente_Dni))*100,
DATA_PRAXIS.OBTENER_ID_PERSONA(asd.Paciente_Dni),
asd.Plan_Med_Codigo,
0,
NULL
FROM (SELECT distinct Paciente_Dni,Plan_Med_Codigo FROM gd_esquema.Maestra WHERE Paciente_Dni is not null) asd

--PROFESIONAL --OK
-------------
INSERT INTO DATA_PRAXIS.PROFESIONAL
SELECT
DATA_PRAXIS.OBTENER_ID_PERSONA(asd.Medico_Dni),
NULL,
NULL

FROM (SELECT distinct Medico_Dni FROM gd_esquema.Maestra WHERE Medico_Dni is not null) asd

--TIPO_ESPECIALIDAD --OK
-------------
INSERT INTO DATA_PRAXIS.TIPO_ESPECIALIDAD
SELECT distinct
Tipo_Especialidad_Codigo,
Tipo_Especialidad_Descripcion
FROM gd_esquema.Maestra 
where Tipo_Especialidad_Codigo is not null


--ESPECIALIDAD --OK
-------------
INSERT INTO DATA_PRAXIS.ESPECIALIDAD
SELECT distinct
Especialidad_Codigo,
Tipo_Especialidad_Codigo,
Especialidad_Descripcion
FROM gd_esquema.Maestra 
where Especialidad_Codigo is not null

--MEDICO_ESPECIALIDAD --OK
-------------------------
INSERT INTO DATA_PRAXIS.PROFESIONAL_ESPECIALIDAD
SELECT (
SELECT id_profesional FROM DATA_PRAXIS.PROFESIONAL 
WHERE id_persona=(SELECT aux.id_persona FROM DATA_PRAXIS.PERSONA aux where aux.numero_documento = asd.Medico_Dni)
), asd.Especialidad_Codigo

FROM
(SELECT DISTINCT Medico_Dni, Especialidad_Codigo FROM gd_esquema.Maestra WHERE Medico_Dni is not null) asd
